javascript:
  $(function() {

    var reload = function() { window.location.reload(); }

    var reload_timer = #{dashboard.refresh.to_i * 1000};
    
    var reload_countdown_width = 100;

    var counter_timeout = reload_timer / reload_countdown_width;

    if (reload_timer > 0) {
      setInterval(function() {
        reload_countdown_width = reload_countdown_width -1;
        $('.reload-countdown').css('width', reload_countdown_width + "%")
      }, counter_timeout);

      setInterval(function() { reload() }, reload_timer);
    }

    $('.remove-cell.true').on('click', function(event) {
      var cell_id = $(this).closest('.visualization-cell').data('cell-id');
      var action = $(this).data('action');

      if (confirm('Remove this cell?')) {
        $.post('#{remove_visualization_dashboard_path(dashboard)}', { dashboard_cell_id: cell_id })
        .done(function() { reload(); })
        .fail(function(d,e,j) { alert(d.responseText); });
      }
    });

    $('.dashboard-controls .popup.true').on('click', function(event) {
      var selector = $(this).data('selector');
      var el = $('.popups').find(selector);
      var title = el.find('title').text();
      el.dialog(
        {
          title: title,
          resizable: false,
          draggable: false,
          modal: true,
          width: 370,
          show: { effect: 'slideDown', duration: 250 },
          hide: { effect: 'slideUp', duration: 250 },
          close: function (event, ui) {
            $(this).dialog("destroy"); // so the dialog will open again
          }
        }
      );
    });

    $('.popups .add-visualization form').on('submit', function(event) {
      var visualization_id = $(this).find('select').val();
      if (visualization_id.toString().length < 1) {
        alert('Select a visualization first');
        return false;
      }
      return true;
    });

    $('.popups .add-visualization form').bind('ajax:complete', function(e) {
      reload();
    });

    $('.popups .dashboard-settings form').bind('ajax:complete', function(e) {
      reload();
    });

    var dashboardControlsVisible = function() {
      return ($('.dashboard-controls.visible').length > 0);
    };

    var hideDashboardControls = function() {
      $('.dashboard-controls').removeClass('visible');
    };

    var showDashboardControls = function() {
      if (!$('.dashboard-controls').hasClass('visible')) {
        $('.dashboard-controls').addClass('visible');
      }
    };

    var setDashboardControlsHideTimeout = function(){
      return setTimeout(function(){
        if (dashboardControlsVisible()) {
          hideDashboardControls();
        }
      }, 5000);
    };

    var dashboardControlsHiderId = setDashboardControlsHideTimeout();

    var menuHiderId = setDashboardControlsHideTimeout();

    $('body').on('mousemove', function() {
      if (!dashboardControlsVisible()) {
        showDashboardControls();
      }
      if (typeof(dashboardControlsHiderId) != "undefined") {
        clearTimeout(dashboardControlsHiderId);
        dashboardControlsHiderId = setDashboardControlsHideTimeout();
      }  
    });

    var markAutoScrollingElements = function() {
      $('.dashboard .visualization-cell.allow-autoscroll').each(function(index, el) {
        var container = $(el).find('div.container');
        if (container.css('height') > $(el).css('height')) {
          $(el).addClass('do-scrolling');
          present = true;
        }
      });
    }

    var scrollersArePresent = function() {
      markAutoScrollingElements();
      return($('.dashboard .visualization-cell.do-scrolling').length > 0);
    };

    var autoScroll = function(el, scroll_delay) {
      if (!$(el).data('stopped')) {
        var direction = $(el).data('direction') || 'down';
        if (direction == 'down') {
          if ($(el).scrollTop() < ($(el).find('.container').height() - $(el).height())) {
            $(el).scrollTop($(el).scrollTop()+1);
          } else {
            $(el).data('direction', 'up');
          }
        } else {
          if ($(el).scrollTop() > 0 ) {
            $(el).scrollTop($(el).scrollTop()-1);
          } else {
            $(el).data('direction', 'down');
          }
        }
      }
      setTimeout(function(){ autoScroll(el, scroll_delay); }, scroll_delay);
    };

    startAutoScroll = function() {
      if (scrollersArePresent()) {
        $('.visualization-cell.do-scrolling').each(function(index, el) {
          var scroll_delay = $(el).data('scroll-delay');
          autoScroll(el, (scroll_delay || 100));
        });

        $('.visualization-cell.do-scrolling').on('mouseenter', function(event) {
          $(this).data('stopped', true);
          $(this).scrollTop('0');
        });

        $('.visualization-cell.do-scrolling').on('mouseleave', function(event) {
          $(this).data('stopped', false);
        });
      } else {
        console.log('no scrollers to scroll');
      }
    };

    // start autoscrolling after the grid has had time to load. May take
    // a while on slow machings like the Raspi.
    // Comment/uncomment line below to enable or disable autoscrolling.
    //setTimeout(function() { startAutoScroll() }, 10000);

    var syncGridsterChangesToServer = function() {
      var objects = gridster.serialize();
      var done_count = 0;
      for (var index in objects) {
        var object = objects[index];
        var cell_id = object.el.data('cell-id');
        var data = {
          column: object.col,
          row: object.row,
          width: object.size_x,
          height: object.size_y,
        }
        $.post('/dashboard_cells/' + cell_id, data)
          .fail(function(d,e,j) { alert(d.responseText); });
      }
    }

    gridster = $(".gridster .dashboard").gridster({
      widget_margins: [#{dashboard.cell_x_margin}, #{dashboard.cell_y_margin}],
      widget_base_dimensions: [#{dashboard.cell_width}, #{dashboard.cell_height}],
      autogrow_cols: true,
      resize: {
        enabled: true,
        stop: syncGridsterChangesToServer
      },
      draggable: { stop: syncGridsterChangesToServer },
      serialize_params: function($w, wgd) {
        return { el: wgd.el, col: wgd.col, row: wgd.row, size_x: wgd.size_x, size_y: wgd.size_y }
        }
    }).data('gridster');

  });

scss:
  ul.dashboard {
    list-style-type: none;
    li {
      border: 1px solid #1e1e1e;
      overflow: hidden;
    }
  } 

  .visualization-cell {
    .controls {
      display: none;
      position: absolute;
      right:3px;
      top:3px;
      z-index: 1;

      i {
        margin: 0 3px 0 3px;
        &.true {
          &:hover {
            cursor: pointer;
            color: blue;
          }
        }
        &.false {
          &:hover {
            color: red;
          }
        }
      }
    }
    
    &:hover {
      .controls {
        display: block;
      }
    }
  }

  .dashboard-controls {
    &.visible {
      .add { left: 0px; }
      .dashboard-settings { right: 0px; }
    }
    div {
      position: fixed;
      
      padding: 10px;
      background-color: lightgrey;
      opacity: 0.75;
      span {
        display: none;
      }
      &:hover {
        opacity: 1.0;
        z-index: 1;
        
        &.true {
          color: blue;
          cursor: pointer;
        }
        &.false { color: red; }
        
        span {
          display: inline-block;
        }
      }
      transition: all 0.2s ease-out;
      &.add {
        top: 75px;
        left: -35px;
        border-top-right-radius: 1em;
        border-bottom-right-radius: 1em;
        span {
          margin-right: 10px;
        }
      }
      &.dashboard-settings {
        top: 75px;
        right: -35px;
        border-top-left-radius: 1em;
        border-bottom-left-radius: 1em;
        span {
          margin-left: 10px;
        }
      }
    }
  }

  .popups {
    display: none;
  }

- if dashboard.refresh.to_i > 0
  .reload-countdown
.gridster
  ul.dashboard data-dashboard-id=dashboard.id
    - counter = 0
    - max_cell_position = dashboard.dashboard_cells.maximum(:position)
    - while dashboard.dashboard_cells.size >= (counter+1)
      - cell = dashboard.dashboard_cells[counter]
      - break if cell.nil?
      - counter += 1
      li.visualization-cell.allow-autoscroll id="vc_#{cell.id}" data-cell-id=cell.id data-row=cell.row data-col=cell.column  data-sizex=cell.width data-sizey=cell.height
        .container title=cell.visualization.name
          .controls
            i.fa.fa-times.remove-cell.true title="remove this cell"
          = render inline: cell.visualization.markup, type: cell.visualization.markup_type

.dashboard-controls
  .add.popup.true data-selector='.add-visualization'
    span Add Visualization
    i.fa.fa-plus
    
  .dashboard-settings.popup.true data-selector='.dashboard-settings'
    i.fa.fa-cog
    span Settings

.popups    
  .add-visualization
    title Add Visualization
    - if Visualization.enabled.count > 0
      = form_tag add_visualization_dashboard_path(dashboard), remote: true, class: 'pure-form pure-form-aligned'
        fieldset
          .pure-control-group
            = label_tag :visualization_id, "Visualization"
            = select_tag :visualization_id, options_for_select(Visualization.enabled.where(component: false).order('name').map{|v| [v.name, v.id] }), include_blank: true
          .pure-controls
            button type="submit" class="pure-button pure-button-primary" Add
    - else
      - if Visualization.disabled.count > 0
        | No visualizations are enabled! #{link_to 'Please enable some',  visualizations_path}.
      - else
        | No visualizations have been created! #{link_to 'Please make one', new_visualization_path}.

  .dashboard-settings
    title Dashboard Settings
    = form_for(dashboard, remote: true, html: { class: 'pure-form pure-form-aligned' }) do |f|
      = render partial: 'dashboards/form_guts', locals: {f: f }
      
      .pure-controls
        button type="submit" class="pure-button pure-button-primary" Update
